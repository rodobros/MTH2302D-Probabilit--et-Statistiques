<!DOCTYPE html>
<html>
<head>
    <title>Probability Graph</title>
	<!-- CSS code for the selector styles -->
	<style type="text/css">
		canvas{border:#666 1px solid; background-color: white;}
        body {text-align: center; background-color: white;font-family:Arial;}
        button {width: 200px; height: 75px; margin-left:50px;font-size:40px;}
	</style>
    <!--Contains all the javascript functions-->
	<script>
		/*Code that executes immediately after the page is loaded*/
		window.onload = function(){
			showSuccessValue();
		}

		/*setPixel sets a pixel color in a texture, taking
		the x and y coordinates, as well as the Red Green Blue
		and Alpha parameters*/
		function setPixel(texture_, x_, y_, r_, g_, b_, a_){
			var i = (x_ + (y_ * texture_.width)) * 4
			texture_.data[i]     = r_;
			texture_.data[i + 1] = g_;
			texture_.data[i + 2] = b_;
			texture_.data[i + 3] = a_;
		}

        /*Sets the value of the slider*/
		function showSuccessValue(){
			document.getElementById("success_tag").innerHTML = document.getElementById("success").value;
		}

		function testAverageSuccess(success_, repetitions_){
			var result = 0;
			for(var i = 0; i < repetitions_; ++i){
				if(Math.random() < (success_ / 100)){
					++result;
				}
			}
            //Prevent from going out of bound in the case of a 100% test result
			if (result == repetitions_)
			    result--;
			return result;
		}

		function setVerticalLine(texture_, x_, ratio_){
			var vertical = Math.floor(ratio_ * texture_.height)
			var pi = 3.1416;
			for(var i = 0; i < vertical; ++i){
				var r = Math.sin(((pi * i) / (2 * vertical)) + (pi / 2));
				r *= r * 255;
				var g = Math.sin((pi * i) / vertical);
				g *= g * 255;
				var b = Math.sin((pi * i) / (2 * vertical));
				b *= b * 255;
				setPixel(texture_, x_, texture_.height - i, r, g, b, 255);
			}
		}

		function graphShader(texture_, start_, section_, ratio_){
			for(var i = start_; i < (start_ + section_); ++i)
				setVerticalLine(texture_, i, ratio_);

		}
		
		var array = [];
		function graphSuccess(success_, repetitions_, tests_) {

		    if (repetitions_ == 0 || tests_ == 0)
		        return;

            //initialize array
			array.length = repetitions_ ;
			for(var i = 0; i < array.length; ++i)
			    array[i] = 0;

            //fill array with test result
			for(var i = 0; i < tests_; ++i)
			    array[testAverageSuccess(success_, repetitions_)]++;

			var context = canvas.getContext("2d");
			var context2 = canvas2.getContext("2d");
			var texture = context.createImageData(canvas.width, canvas.height -5);
			var section = Math.floor(texture.width / array.length);


			var maxY = arrayMax(array);
			for(var i = 0; i < array.length; ++i)
				graphShader(texture, i * section, section, array[i] / maxY);

            //clear canvas
			context.clearRect(0, 0, canvas.width, canvas.height);
			context.putImageData(texture, 0, 0);
			context2.clearRect(0, 0, canvas.width, canvas.height);
            
			drawLines(repetitions_, tests_, maxY);
			drawAxis(canvas.width, canvas.height, 'canvas');
			drawAxis(canvas2.width, canvas2.height, 'canvas2');
			drawLoiNormal();
			showMoyenne();

		}
		
				
		function drawLines(echantillonParTests_, nbreTests_, maxY_){
			var canvas = document.getElementById("canvas");
			var context = canvas.getContext("2d");

            //number of x and y lines
			var xLines = Math.ceil(canvas.width / echantillonParTests_);
			var yLines
			if (maxY_ <= 150)
			    yLines = Math.ceil(canvas.height / maxY_);
			else
			    yLines = 3;
				
            //draw x lines
			for(var x = 0 ; x < canvas.width ; x +=xLines)
			{
				context.moveTo(x, 0);
				context.lineTo(x, canvas.height);
			}
			//draw y lines
			for(var y = 0 ; y < canvas.height ; y +=yLines)
			{
				context.moveTo(0, y);
				context.lineTo(canvas.width, y);
			}
			context.strokeStyle = "#eee";
			context.lineWidth = 0.5;
			context.stroke();
			
			context.fillText("100%", canvas.width - 40, canvas.height - 10);
			context.fillText(maxY_, 10, 20);
		}
		
        //Dessine les axes x et y pour les 2 graphiques
		function drawAxis(largeur_, hauteur_, nomCanvas_)
		{
			var canvas = document.getElementById(nomCanvas_);
			var context = canvas.getContext("2d");
		
			context.beginPath();

			//dessiner axe des x
			context.moveTo(0, hauteur_ - 5);
			context.lineTo(largeur_ / 2 - 10, hauteur_ - 5);
			context.moveTo(largeur_ / 2 + 10, hauteur_ - 5);
			context.lineTo(largeur_, hauteur_ - 5);
            //dessiner fleche axe des x
			context.moveTo(largeur_ - 5, hauteur_ - 10);
			context.lineTo(largeur_, hauteur_ - 5);
			context.lineTo(largeur_ - 5, hauteur_ );
			//dessiner axe des y
			context.moveTo(5, 0);
			context.lineTo(5, hauteur_ / 2 - 10);
			context.moveTo(5, hauteur_ / 2 + 10);
			context.lineTo(5, hauteur_);
			//dessiner fleche axe des y
			context.moveTo(10, 5);
			context.lineTo(5, 0);
			context.lineTo(0, 5);

			context.strokeStyle = "#000";
			for(var i = 0 ; i < 100 ; i++)
				context.stroke();
			
            //identifer axes
			context.font = "bold 15px sans-serif";
			context.fillText("x", largeur_ / 2 - 5, hauteur_ - 2);
			context.fillText("y", 5, hauteur_ / 2 + 5);
		
		}
		
		function drawLoiNormal()
		{
            //Cases where normal law doesn't apply
		    if (success.value == 0 || success.value == 100)
		        return;

			var context = canvas2.getContext("2d");
			context.beginPath();
			context.moveTo(0, canvas.height + 5);
			for(var x = 0; x < canvas2.width; x++)
			{
			    context.lineTo(x, (canvas2.height-5 - (loiNormale(x))));
			}
			context.strokeStyle = "#000";
			context.stroke();
			context.fillText("LOI NORMALE", 25, 20);
		
		}
		
		function loiNormale(x_)
		{
		    var pie = 3.14;
		    x_ = positionXLoiNormale(x_);
			return (1/(Math.sqrt(2*(pie))))*(Math.exp((-1/2)*(x_*x_))) * ratioHauteurLoiNormale();
		}
		
        //Retourne le ratio de proportionnalite avec la hauteur max du graphique
		function ratioHauteurLoiNormale()
		{
		    return (canvas2.height - 5) / 0.4;
		}

		//Retourne la valeur de position x du graphique de la loi 
		//normale correspondante a la position x du pixel
		function positionXLoiNormale(x_)
		{
		    return (x_ - canvas2.width * (success.value / 100)) / 25;
		}
	

		/*This function returns the max value contained in an array*/
		function arrayMax(array_){
		    return Math.max.apply(Math, array_);
		};
		
		function arrayMoyenne(){
			var returnValue = 0;
			var tests = 0;
			for(var i = 0 ; i < array.length ; ++i)
			{
				returnValue = returnValue + (array[i])*i;
				tests = tests + array[i];
			}
			return (returnValue / array.length / tests);
		}

		function showMoyenne()
		{
			document.getElementById("moyenne").innerHTML = arrayMoyenne();
		}

		function keepRange()
		{
		    if (samples.value > 200)
		        samples.value = 200;
		    else if (samples.value < 10)
		        samples.value = 10;
		}

	</script>
</head>

<!--Contains the html code for the page content-->
<body>
    <!-- The main canvas -->

	<p style="text-decoration:underline; font-size:20px">Démonstration de la loi normale</p>
    <canvas id="canvas" width="600" height="450">
	</canvas>
	<canvas id="canvas2" width="600" height="450">
	</canvas>
	<script>
	  drawAxis(canvas.width, canvas.height, "canvas", false)
	  drawAxis(canvas2.width, canvas2.height, "canvas2", true)
	</script>
    <br>
    <br>
    <div>
		<p style="display:inline">x : Pourcentage de succès </p>
		<p style="display:inline; margin-left:50px">y : Nombre de tests </p>
        <p >Moyenne : </p> 
        <p id="moyenne" />
        <p style="display:inline">Probabilité de succès : </p>
	    <input type = "range" id = "success" min = "0" max = "100" value = "50" step = "1" onchange ="showSuccessValue()" oninput= "showSuccessValue()" style = "width: 600px; height: 20px;" />
        <p id="success_tag" style="display:inline"/>1
        <p style="display:inline">%</p>
        <br>
        <br>
        <p style="display:inline">Échantillons par tests(max 200) : </p>
	    <input id = "samples" type = "number" min = "10" max = "200"  value = "200" style = "width: 100px; height: 30px;" onkeypress='return event.charCode >= 48 && event.charCode <= 57' onchange="keepRange()"/>
        <p style="display:inline; margin-left:50px">Total de tests : </p>
	    <input id = "tests" type = "number" value = "1000" style = "width: 100px; height: 30px;" onkeypress='return event.charCode >= 48 && event.charCode <= 57' />
        <button type="button" onclick="graphSuccess(success.value, samples.value, tests.value)">Graphique</button>
    </div>
</body>

</html>